<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Highlighted Syntax</title>
    <link rel="stylesheet" href="highlight.css">
</head>

<body>
    <pre>
<span class="comment"># Script copied from https://gist.github.com/HiroNakamura/4650385</span>

<span class="reserved_words">import</span> <span class="variable">numpy</span> <span class="reserved_words">as</span> <span class="variable">np</span>
<span class="reserved_words">import</span> <span class="variable">pandas</span> <span class="reserved_words">as</span> <span class="variable">pd</span>

<span class="reserved_words">class</span> <span class="func_name">waterfall</span><span class="paren">()</span><span class="punctuation">:</span>
    <span class="reserved_words">def</span> <span class="func_name">__init__</span><span class="paren">(</span><span class="variable">self</span><span class="punctuation">,</span> <span class="variable">data</span><span class="punctuation">,</span> <span class="variable">shap_values</span><span class="punctuation">,</span> 
                       <span class="variable">base_value</span><span class="punctuation">,</span> 
                       <span class="variable">path</span> <span class="smooth_operator">=</span> <span class="string">""</span><span class="punctuation">,</span>
                       <span class="variable">green_color</span> <span class="smooth_operator">=</span><span class="string">'#29EA38'</span> <span class="punctuation">,</span> 
                       <span class="variable">red_color</span> <span class="smooth_operator">=</span> <span class="string">'#FB3C62'</span><span class="punctuation">,</span> 
                       <span class="variable">n</span><span class="smooth_operator">=</span><span class="number">8</span><span class="punctuation">,</span>
                       <span class="variable">title</span><span class="smooth_operator">=</span><span class="string">"The Prediction "</span> <span class="punctuation">,</span>
                       <span class="variable">x_lab</span><span class="smooth_operator">=</span><span class="string">""</span><span class="punctuation">,</span>
                       <span class="variable">y_lab</span><span class="smooth_operator">=</span><span class="string">"The predicted value"</span><span class="punctuation">,</span>
                       <span class="variable">formatting</span> <span class="smooth_operator">=</span> <span class="string">"{:,.2f}"</span><span class="punctuation">,</span>
                       <span class="variable">rotation_value</span> <span class="smooth_operator">=</span> <span class="number">90</span><span class="punctuation">,</span>
                       <span class="variable">figsize</span> <span class="smooth_operator">=</span> <span class="paren">(</span><span class="number">7</span><span class="punctuation">,</span><span class="number">5</span><span class="paren">)</span>
                
                <span class="paren">)</span><span class="punctuation">:</span>
        <span class="variable">self</span><span class="punctuation">.</span><span class="variable">data</span>        <span class="smooth_operator">=</span> <span class="variable">data</span>
        <span class="variable">self</span><span class="punctuation">.</span><span class="variable">shap_values</span> <span class="smooth_operator">=</span> <span class="variable">shap_values</span>
        <span class="variable">self</span><span class="punctuation">.</span><span class="variable">base_value</span>  <span class="smooth_operator">=</span> <span class="variable">base_value</span>
        <span class="variable">self</span><span class="punctuation">.</span><span class="variable">green_color</span> <span class="smooth_operator">=</span> <span class="variable">green_color</span>
        <span class="variable">self</span><span class="punctuation">.</span><span class="variable">red_color</span>   <span class="smooth_operator">=</span> <span class="variable">red_color</span>
        <span class="variable">self</span><span class="punctuation">.</span><span class="variable">n</span>           <span class="smooth_operator">=</span> <span class="variable">n</span>
        <span class="variable">self</span><span class="punctuation">.</span><span class="variable">title</span>       <span class="smooth_operator">=</span> <span class="variable">title</span>
        <span class="variable">self</span><span class="punctuation">.</span><span class="variable">x_lab</span>       <span class="smooth_operator">=</span> <span class="variable">x_lab</span>
        <span class="variable">self</span><span class="punctuation">.</span><span class="variable">y_lab</span>       <span class="smooth_operator">=</span> <span class="variable">y_lab</span>
        <span class="variable">self</span><span class="punctuation">.</span><span class="variable">formatting</span>  <span class="smooth_operator">=</span> <span class="variable">formatting</span>
        <span class="variable">self</span><span class="punctuation">.</span><span class="variable">rotation_value</span> <span class="smooth_operator">=</span> <span class="variable">rotation_value</span>
        <span class="variable">self</span><span class="punctuation">.</span><span class="variable">figsize</span>     <span class="smooth_operator">=</span> <span class="variable">figsize</span>
        <span class="variable">self</span><span class="punctuation">.</span><span class="variable">_plot</span>       <span class="smooth_operator">=</span> <span class="variable">pd</span><span class="punctuation">.</span><span class="func_name">DataFrame</span><span class="paren">()</span>
        <span class="variable">self</span><span class="punctuation">.</span><span class="variable">path</span>        <span class="smooth_operator">=</span> <span class="variable">path</span>

    <span class="reserved_words">def</span> <span class="func_name">obs_to_explain</span><span class="paren">(</span><span class="variable">self</span><span class="paren">)</span><span class="punctuation">:</span>
        <span class="string">''</span>'
          <span class="smooth_operator">-</span> <span class="variable">data</span><span class="punctuation">:</span> <span class="variable">the</span> <span class="variable">observation</span><span class="punctuation">.</span> <span class="variable">It</span> <span class="reserved_words">is</span> <span class="variable">a</span> <span class="variable">Pandas</span> <span class="variable">series</span><span class="punctuation">.</span> <span class="variable">The</span> <span class="variable">index</span> <span class="variable">contains</span> <span class="variable">the</span> <span class="variable">variable</span> <span class="variable">names</span> 
          <span class="smooth_operator">-</span> <span class="variable">shap_values</span><span class="punctuation">:</span> <span class="variable">the</span> <span class="variable">shap_values</span> <span class="reserved_words">for</span> <span class="variable">the</span> <span class="variable">above</span> <span class="variable">observation</span> 
          <span class="smooth_operator">-</span> <span class="variable">base_value</span><span class="punctuation">:</span> <span class="variable">the</span> <span class="variable">base_value</span><span class="punctuation">,</span> <span class="variable">which</span> <span class="reserved_words">is</span> <span class="variable">the</span> <span class="variable">expected</span> <span class="variable">value</span> <span class="reserved_words">or</span> <span class="variable">the</span> <span class="variable">mean</span> <span class="variable">of</span> <span class="variable">the</span> <span class="variable">target</span> <span class="variable">value</span> <span class="variable">of</span> <span class="variable">the</span> <span class="variable">training</span> <span class="variable">set</span>
          <span class="smooth_operator">-</span> <span class="variable">green_color</span><span class="punctuation">:</span> <span class="variable">the</span> <span class="variable">color</span> <span class="reserved_words">for</span> <span class="variable">the</span> <span class="variable">up</span> <span class="variable">bar</span>
          <span class="smooth_operator">-</span> <span class="variable">red_color</span><span class="punctuation">:</span> <span class="variable">the</span> <span class="variable">color</span> <span class="reserved_words">for</span> <span class="variable">the</span> <span class="variable">down</span> <span class="variable">bar</span>
          <span class="smooth_operator">-</span> <span class="variable">for_plot</span><span class="punctuation">:</span> <span class="variable">a</span> <span class="variable">sorted</span> <span class="variable">data</span> <span class="variable">frame</span> <span class="variable">by</span> <span class="variable">the</span> <span class="variable">absolute</span> <span class="variable">value</span> <span class="variable">of</span> <span class="variable">shape</span> <span class="reserved_words">in</span> <span class="variable">descending</span> <span class="variable">order</span>
          <span class="smooth_operator">-</span> <span class="variable">n</span><span class="punctuation">:</span> <span class="variable">show</span> <span class="variable">the</span> <span class="variable">top</span> <span class="variable">n</span> <span class="paren">(</span><span class="variable">default</span><span class="paren">)</span> <span class="variable">variables</span><span class="punctuation">.</span> <span class="variable">The</span> <span class="variable">rest</span> <span class="variable">variables</span> <span class="variable">are</span> <span class="variable">summed</span> <span class="variable">up</span> <span class="variable">into</span> <span class="string">"others"</span>
        <span class="string">''</span>'
        <span class="variable">for_plot</span> <span class="smooth_operator">=</span> <span class="variable">pd</span><span class="punctuation">.</span><span class="func_name">DataFrame</span><span class="paren">(</span><span class="keys">{</span><span class="string">'data'</span><span class="punctuation">:</span><span class="variable">np</span><span class="punctuation">.</span><span class="func_name">round</span><span class="paren">(</span><span class="variable">self</span><span class="punctuation">.</span><span class="variable">data</span><span class="punctuation">,</span><span class="number">2</span><span class="paren">)</span><span class="punctuation">,</span>
                                 <span class="string">'shap'</span><span class="punctuation">:</span><span class="variable">self</span><span class="punctuation">.</span><span class="variable">shap_values</span><span class="punctuation">,</span>
                                 <span class="string">'shap_abs'</span><span class="punctuation">:</span> <span class="variable">np</span><span class="punctuation">.</span><span class="func_name">abs</span><span class="paren">(</span><span class="variable">self</span><span class="punctuation">.</span><span class="variable">shap_values</span><span class="paren">)</span><span class="punctuation">,</span>
                                 <span class="string">'label'</span><span class="punctuation">:</span> <span class="variable">self</span><span class="punctuation">.</span><span class="variable">data</span><span class="punctuation">.</span><span class="variable">index</span>
                                <span class="keys">}</span><span class="paren">)</span>
        <span class="variable">for_plot</span> <span class="smooth_operator">=</span> <span class="variable">for_plot</span><span class="punctuation">.</span><span class="func_name">sort_values</span><span class="paren">(</span><span class="variable">by</span><span class="smooth_operator">=</span><span class="string">'shap_abs'</span><span class="punctuation">,</span><span class="variable">ascending</span><span class="smooth_operator">=</span><span class="variable">False</span><span class="paren">)</span>

        <span class="comment"># Split the variables into n and the rest. Only show the top n</span>
        <span class="variable">for_plot1</span> <span class="smooth_operator">=</span> <span class="variable">for_plot</span><span class="punctuation">.</span><span class="variable">iloc</span><span class="brackets">[</span><span class="number">0</span><span class="punctuation">:</span><span class="variable">self</span><span class="punctuation">.</span><span class="variable">n</span><span class="punctuation">,</span><span class="punctuation">:</span><span class="brackets">]</span>
        <span class="variable">for_plot2</span> <span class="smooth_operator">=</span> <span class="variable">for_plot</span><span class="punctuation">.</span><span class="variable">iloc</span><span class="brackets">[</span><span class="variable">self</span><span class="punctuation">.</span><span class="variable">n</span><span class="punctuation">:</span><span class="punctuation">,</span><span class="punctuation">:</span><span class="brackets">]</span>

        <span class="comment"># Sum up the rest as 'others'</span>
        <span class="variable">rest</span> <span class="smooth_operator">=</span> <span class="variable">pd</span><span class="punctuation">.</span><span class="func_name">DataFrame</span><span class="paren">(</span><span class="keys">{</span><span class="string">'data'</span><span class="punctuation">:</span> <span class="string">''</span><span class="punctuation">,</span><span class="string">'shap'</span><span class="punctuation">:</span><span class="variable">for_plot2</span><span class="brackets">[</span><span class="string">'shap'</span><span class="brackets">]</span><span class="punctuation">.</span><span class="func_name">sum</span><span class="paren">()</span><span class="punctuation">,</span> <span class="string">'label'</span><span class="punctuation">:</span> <span class="string">'Others'</span><span class="keys">}</span><span class="punctuation">,</span><span class="variable">index</span><span class="smooth_operator">=</span><span class="brackets">[</span><span class="string">'others'</span><span class="brackets">]</span><span class="paren">)</span>
        <span class="variable">for_plot</span> <span class="smooth_operator">=</span> <span class="variable">for_plot1</span><span class="punctuation">.</span><span class="func_name">append</span><span class="paren">(</span><span class="variable">rest</span><span class="paren">)</span>

        <span class="comment"># Sum up the rest into 'others'</span>
        <span class="variable">base</span> <span class="smooth_operator">=</span> <span class="variable">pd</span><span class="punctuation">.</span><span class="func_name">DataFrame</span><span class="paren">(</span><span class="keys">{</span><span class="string">'data'</span><span class="punctuation">:</span> <span class="variable">np</span><span class="punctuation">.</span><span class="func_name">round</span><span class="paren">(</span><span class="variable">self</span><span class="punctuation">.</span><span class="variable">base_value</span><span class="punctuation">,</span><span class="number">2</span><span class="paren">)</span><span class="punctuation">,</span><span class="string">'shap'</span><span class="punctuation">:</span><span class="variable">self</span><span class="punctuation">.</span><span class="variable">base_value</span><span class="punctuation">,</span> <span class="string">'label'</span><span class="punctuation">:</span> <span class="string">'Base value'</span><span class="keys">}</span><span class="punctuation">,</span><span class="variable">index</span><span class="smooth_operator">=</span><span class="brackets">[</span><span class="string">'base_value'</span><span class="brackets">]</span><span class="paren">)</span>
        <span class="variable">for_plot</span> <span class="smooth_operator">=</span> <span class="variable">base</span><span class="punctuation">.</span><span class="func_name">append</span><span class="paren">(</span><span class="variable">for_plot</span><span class="paren">)</span>

        <span class="variable">for_plot</span><span class="brackets">[</span><span class="string">'blank'</span><span class="brackets">]</span> <span class="smooth_operator">=</span> <span class="variable">for_plot</span><span class="brackets">[</span><span class="string">'shap'</span><span class="brackets">]</span><span class="punctuation">.</span><span class="func_name">cumsum</span><span class="paren">()</span><span class="punctuation">.</span><span class="func_name">shift</span><span class="paren">(</span><span class="number">1</span><span class="paren">)</span><span class="punctuation">.</span><span class="func_name">fillna</span><span class="paren">(</span><span class="number">0</span><span class="paren">)</span> <span class="comment"># +  base_value</span>
        <span class="variable">for_plot</span><span class="brackets">[</span><span class="string">'label'</span><span class="brackets">]</span> <span class="smooth_operator">=</span> <span class="smooth_operator">+</span> <span class="variable">for_plot</span><span class="brackets">[</span><span class="string">'label'</span><span class="brackets">]</span> <span class="smooth_operator">+</span> <span class="string">" ="</span> <span class="smooth_operator">+</span> <span class="variable">for_plot</span><span class="brackets">[</span><span class="string">'data'</span><span class="brackets">]</span><span class="punctuation">.</span><span class="func_name">map</span><span class="paren">(</span><span class="variable">str</span><span class="paren">)</span> 
        <span class="variable">for_plot</span><span class="brackets">[</span><span class="string">'color'</span><span class="brackets">]</span> <span class="smooth_operator">=</span> <span class="variable">np</span><span class="punctuation">.</span><span class="func_name">where</span><span class="paren">(</span><span class="variable">for_plot</span><span class="brackets">[</span><span class="string">'shap'</span><span class="brackets">]</span><span class="smooth_operator">></span><span class="number">0</span><span class="punctuation">,</span><span class="variable">self</span><span class="punctuation">.</span><span class="variable">green_color</span><span class="punctuation">,</span><span class="variable">self</span><span class="punctuation">.</span><span class="variable">red_color</span><span class="paren">)</span>
        <span class="variable">for_plot</span> <span class="smooth_operator">=</span> <span class="variable">for_plot</span><span class="punctuation">.</span><span class="func_name">drop</span><span class="paren">(</span><span class="brackets">[</span><span class="string">'data'</span><span class="punctuation">,</span><span class="string">'shap_abs'</span><span class="brackets">]</span><span class="punctuation">,</span><span class="variable">axis</span><span class="smooth_operator">=</span><span class="number">1</span><span class="paren">)</span>
        
        <span class="variable">self</span><span class="punctuation">.</span><span class="variable">for_plot</span> <span class="smooth_operator">=</span> <span class="variable">for_plot</span>
        
        <span class="func_name">return</span><span class="paren">(</span><span class="variable">for_plot</span> <span class="paren">)</span> 
    
    <span class="reserved_words">def</span> <span class="func_name">plt_plot</span><span class="paren">(</span><span class="variable">self</span><span class="paren">)</span><span class="punctuation">:</span>
        <span class="string">''</span>'
          <span class="smooth_operator">-</span> <span class="variable">x_lab</span><span class="punctuation">,</span> <span class="variable">y_lab</span><span class="punctuation">:</span> <span class="variable">the</span> <span class="variable">x</span> <span class="variable">label</span> <span class="reserved_words">and</span> <span class="variable">y</span> <span class="variable">label</span>
          <span class="smooth_operator">-</span> <span class="variable">formatting</span><span class="punctuation">:</span> <span class="variable">show</span> <span class="variable">the</span> <span class="variable">value</span> <span class="variable">of</span> <span class="variable">each</span> <span class="variable">bar</span> 
        <span class="string">''</span>'

        <span class="variable">fig</span><span class="punctuation">,</span> <span class="variable">ax</span> <span class="smooth_operator">=</span> <span class="variable">plt</span><span class="punctuation">.</span><span class="func_name">subplots</span><span class="paren">(</span><span class="variable">figsize</span><span class="smooth_operator">=</span><span class="variable">self</span><span class="punctuation">.</span><span class="variable">figsize</span><span class="paren">)</span>

        <span class="comment"># Plot the waterfall    </span>
        <span class="variable">plt</span><span class="punctuation">.</span><span class="func_name">bar</span><span class="paren">(</span><span class="func_name">range</span><span class="paren">(</span><span class="number">0</span><span class="punctuation">,</span><span class="func_name">len</span><span class="paren">(</span><span class="variable">self</span><span class="punctuation">.</span><span class="variable">for_plot</span><span class="punctuation">.</span><span class="variable">index</span><span class="paren">))</span><span class="punctuation">,</span> <span class="variable">self</span><span class="punctuation">.</span><span class="variable">for_plot</span><span class="brackets">[</span><span class="string">'shap'</span><span class="brackets">]</span><span class="punctuation">,</span> <span class="variable">width</span><span class="smooth_operator">=</span><span class="number">0.6</span><span class="punctuation">,</span>
              <span class="variable">bottom</span><span class="smooth_operator">=</span><span class="variable">self</span><span class="punctuation">.</span><span class="variable">for_plot</span><span class="brackets">[</span><span class="string">'blank'</span><span class="brackets">]</span><span class="punctuation">,</span>     <span class="variable">color</span><span class="smooth_operator">=</span><span class="variable">self</span><span class="punctuation">.</span><span class="variable">for_plot</span><span class="brackets">[</span><span class="string">'color'</span><span class="brackets">]</span><span class="paren">)</span>     

        <span class="comment">#axis labels</span>
        <span class="variable">plt</span><span class="punctuation">.</span><span class="func_name">xlabel</span><span class="paren">(</span><span class="string">"\n"</span> <span class="smooth_operator">+</span> <span class="variable">self</span><span class="punctuation">.</span><span class="variable">x_lab</span><span class="paren">)</span>
        <span class="variable">plt</span><span class="punctuation">.</span><span class="func_name">ylabel</span><span class="paren">(</span><span class="variable">self</span><span class="punctuation">.</span><span class="variable">y_lab</span> <span class="smooth_operator">+</span> <span class="string">"\n"</span><span class="paren">)</span>

        <span class="comment">#Get the y-axis position for the labels</span>
        <span class="variable">y_height</span> <span class="smooth_operator">=</span> <span class="variable">self</span><span class="punctuation">.</span><span class="variable">for_plot</span><span class="punctuation">.</span><span class="variable">shap</span><span class="punctuation">.</span><span class="func_name">cumsum</span><span class="paren">()</span><span class="punctuation">.</span><span class="func_name">shift</span><span class="paren">(</span><span class="number">1</span><span class="paren">)</span><span class="punctuation">.</span><span class="func_name">fillna</span><span class="paren">(</span><span class="number">0</span><span class="paren">)</span>

        <span class="variable">plot_max</span> <span class="smooth_operator">=</span> <span class="variable">self</span><span class="punctuation">.</span><span class="variable">for_plot</span><span class="brackets">[</span><span class="string">'shap'</span><span class="brackets">]</span><span class="punctuation">.</span><span class="func_name">max</span><span class="paren">()</span>
        <span class="variable">plot_min</span> <span class="smooth_operator">=</span> <span class="variable">self</span><span class="punctuation">.</span><span class="variable">for_plot</span><span class="brackets">[</span><span class="string">'shap'</span><span class="brackets">]</span><span class="punctuation">.</span><span class="func_name">min</span><span class="paren">()</span>
        <span class="variable">pos_offset</span> <span class="smooth_operator">=</span> <span class="variable">plot_max</span> <span class="smooth_operator">/</span> <span class="number">40</span>
        <span class="variable">plot_offset</span> <span class="smooth_operator">=</span> <span class="variable">plot_max</span> <span class="smooth_operator">/</span> <span class="number">15</span> 
        <span class="variable">total</span> <span class="smooth_operator">=</span> <span class="variable">self</span><span class="punctuation">.</span><span class="variable">for_plot</span><span class="punctuation">.</span><span class="func_name">sum</span><span class="paren">()</span><span class="punctuation">.</span><span class="variable">shap</span> 

        <span class="comment"># label the shap values</span>
        <span class="variable">loop</span> <span class="smooth_operator">=</span> <span class="number">0</span>
        <span class="reserved_words">for</span> <span class="variable">index</span><span class="punctuation">,</span> <span class="variable">row</span> <span class="reserved_words">in</span> <span class="variable">self</span><span class="punctuation">.</span><span class="variable">for_plot</span><span class="punctuation">.</span><span class="func_name">iterrows</span><span class="paren">()</span><span class="punctuation">:</span>
            <span class="comment"># For the last item in the list, we don't want to double count</span>
            <span class="reserved_words">if</span> <span class="variable">row</span><span class="brackets">[</span><span class="string">'shap'</span><span class="brackets">]</span> <span class="smooth_operator">=</span><span class="smooth_operator">=</span> <span class="variable">total</span><span class="punctuation">:</span>
                    <span class="variable">y</span> <span class="smooth_operator">=</span> <span class="variable">y_height</span><span class="brackets">[</span><span class="variable">loop</span><span class="brackets">]</span>
            <span class="variable">else</span><span class="punctuation">:</span>
                    <span class="variable">y</span> <span class="smooth_operator">=</span> <span class="variable">y_height</span><span class="brackets">[</span><span class="variable">loop</span><span class="brackets">]</span> <span class="smooth_operator">+</span> <span class="variable">row</span><span class="brackets">[</span><span class="string">'shap'</span><span class="brackets">]</span>

            <span class="reserved_words">if</span> <span class="variable">row</span><span class="brackets">[</span><span class="string">'shap'</span><span class="brackets">]</span> <span class="smooth_operator">></span> <span class="number">0</span><span class="punctuation">:</span>
                    <span class="variable">y</span> <span class="smooth_operator">+</span><span class="smooth_operator">=</span> <span class="paren">(</span><span class="variable">pos_offset</span><span class="smooth_operator">*</span><span class="number">2</span><span class="paren">)</span>
                    <span class="variable">plt</span><span class="punctuation">.</span><span class="func_name">annotate</span><span class="paren">(</span><span class="variable">self</span><span class="punctuation">.</span><span class="variable">formatting</span><span class="punctuation">.</span><span class="func_name">format</span><span class="paren">(</span><span class="variable">row</span><span class="brackets">[</span><span class="string">'shap'</span><span class="brackets">]</span><span class="paren">)</span><span class="punctuation">,</span><span class="paren">(</span><span class="variable">loop</span><span class="punctuation">,</span><span class="variable">y</span><span class="paren">)</span><span class="punctuation">,</span><span class="variable">ha</span><span class="smooth_operator">=</span><span class="string">"center"</span><span class="punctuation">,</span> <span class="variable">color</span> <span class="smooth_operator">=</span> <span class="variable">self</span><span class="punctuation">.</span><span class="variable">green_color</span><span class="punctuation">,</span> <span class="variable">fontsize</span><span class="smooth_operator">=</span><span class="number">10</span><span class="paren">)</span>
            <span class="variable">else</span><span class="punctuation">:</span>
                    <span class="variable">y</span> <span class="smooth_operator">-</span><span class="smooth_operator">=</span> <span class="paren">(</span><span class="variable">pos_offset</span><span class="smooth_operator">*</span><span class="number">4</span><span class="paren">)</span>
                    <span class="variable">plt</span><span class="punctuation">.</span><span class="func_name">annotate</span><span class="paren">(</span><span class="variable">self</span><span class="punctuation">.</span><span class="variable">formatting</span><span class="punctuation">.</span><span class="func_name">format</span><span class="paren">(</span><span class="variable">row</span><span class="brackets">[</span><span class="string">'shap'</span><span class="brackets">]</span><span class="paren">)</span><span class="punctuation">,</span><span class="paren">(</span><span class="variable">loop</span><span class="punctuation">,</span><span class="variable">y</span><span class="paren">)</span><span class="punctuation">,</span><span class="variable">ha</span><span class="smooth_operator">=</span><span class="string">"center"</span><span class="punctuation">,</span> <span class="variable">color</span> <span class="smooth_operator">=</span> <span class="variable">self</span><span class="punctuation">.</span><span class="variable">red_color</span><span class="punctuation">,</span> <span class="variable">fontsize</span><span class="smooth_operator">=</span><span class="number">10</span><span class="paren">)</span>
            <span class="variable">loop</span><span class="smooth_operator">+</span><span class="smooth_operator">=</span><span class="number">1</span>

        <span class="comment"># Range of the ylim</span>
        <span class="variable">plt</span><span class="punctuation">.</span><span class="func_name">ylim</span><span class="paren">(</span><span class="variable">plot_min</span><span class="smooth_operator">-</span><span class="func_name">round</span><span class="paren">(</span><span class="number">3.6</span><span class="smooth_operator">*</span><span class="variable">plot_offset</span><span class="punctuation">,</span> <span class="number">7</span><span class="paren">)</span> <span class="punctuation">,</span><span class="variable">plot_max</span><span class="smooth_operator">+</span><span class="func_name">round</span><span class="paren">(</span><span class="number">3.6</span><span class="smooth_operator">*</span><span class="variable">plot_offset</span><span class="punctuation">,</span> <span class="number">7</span><span class="paren">))</span>

        <span class="comment">#Rotate the labels</span>
        <span class="variable">plt</span><span class="punctuation">.</span><span class="func_name">xticks</span><span class="paren">(</span><span class="func_name">range</span><span class="paren">(</span><span class="number">0</span><span class="punctuation">,</span><span class="func_name">len</span><span class="paren">(</span><span class="variable">self</span><span class="punctuation">.</span><span class="variable">for_plot</span><span class="paren">))</span><span class="punctuation">,</span> <span class="variable">self</span><span class="punctuation">.</span><span class="variable">for_plot</span><span class="brackets">[</span><span class="string">'label'</span><span class="brackets">]</span><span class="punctuation">,</span> <span class="variable">rotation</span><span class="smooth_operator">=</span><span class="variable">self</span><span class="punctuation">.</span><span class="variable">rotation_value</span><span class="paren">)</span>

        <span class="comment">#add the base value line and title</span>
        <span class="comment">#plt.axhline(base_value, color='black', linewidth = 0.6, linestyle="dashed")</span>
        <span class="variable">plt</span><span class="punctuation">.</span><span class="func_name">title</span><span class="paren">(</span><span class="variable">self</span><span class="punctuation">.</span><span class="variable">title</span><span class="paren">)</span>

        <span class="reserved_words">import</span> <span class="variable">matplotlib</span><span class="punctuation">.</span><span class="variable">patches</span> <span class="reserved_words">as</span> <span class="variable">mpatches</span>
        <span class="variable">red_patch</span> <span class="smooth_operator">=</span> <span class="variable">mpatches</span><span class="punctuation">.</span><span class="func_name">Patch</span><span class="paren">(</span><span class="variable">color</span><span class="smooth_operator">=</span><span class="variable">self</span><span class="punctuation">.</span><span class="variable">red_color</span><span class="punctuation">,</span> <span class="variable">label</span><span class="smooth_operator">=</span><span class="string">'Down'</span><span class="paren">)</span>
        <span class="variable">green_patch</span> <span class="smooth_operator">=</span> <span class="variable">mpatches</span><span class="punctuation">.</span><span class="func_name">Patch</span><span class="paren">(</span><span class="variable">color</span><span class="smooth_operator">=</span><span class="variable">self</span><span class="punctuation">.</span><span class="variable">green_color</span><span class="punctuation">,</span> <span class="variable">label</span><span class="smooth_operator">=</span><span class="string">'Up'</span><span class="paren">)</span>
        <span class="variable">plt</span><span class="punctuation">.</span><span class="func_name">legend</span><span class="paren">(</span><span class="variable">handles</span><span class="smooth_operator">=</span><span class="brackets">[</span><span class="variable">red_patch</span><span class="punctuation">,</span><span class="variable">green_patch</span><span class="brackets">]</span><span class="punctuation">,</span><span class="variable">bbox_to_anchor</span><span class="smooth_operator">=</span><span class="brackets">[</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">1</span><span class="brackets">]</span><span class="punctuation">,</span> <span class="variable">loc</span><span class="smooth_operator">=</span><span class="string">'upper left'</span><span class="paren">)</span>

        <span class="comment">#plt.tight_layout()</span>
        <span class="comment">#return(fig)</span>
    
    <span class="reserved_words">def</span> <span class="func_name">plotly_plot</span><span class="paren">(</span><span class="variable">self</span><span class="paren">)</span><span class="punctuation">:</span>
        <span class="reserved_words">import</span> <span class="variable">plotly</span><span class="punctuation">.</span><span class="variable">graph_objects</span> <span class="reserved_words">as</span> <span class="variable">go</span>
        <span class="reserved_words">import</span> <span class="variable">numpy</span> <span class="reserved_words">as</span> <span class="variable">np</span>

        <span class="variable">ys</span> <span class="smooth_operator">=</span> <span class="variable">self</span><span class="punctuation">.</span><span class="variable">for_plot</span><span class="brackets">[</span><span class="string">'shap'</span><span class="brackets">]</span><span class="punctuation">.</span><span class="func_name">round</span><span class="paren">(</span><span class="number">2</span><span class="paren">)</span>
        <span class="variable">ms</span> <span class="smooth_operator">=</span> <span class="func_name">list</span><span class="paren">(</span><span class="variable">np</span><span class="punctuation">.</span><span class="func_name">repeat</span><span class="paren">(</span><span class="string">'relative'</span><span class="punctuation">,</span><span class="func_name">len</span><span class="paren">(</span><span class="variable">ys</span><span class="paren">)))</span>
        <span class="variable">xs</span> <span class="smooth_operator">=</span> <span class="func_name">list</span><span class="paren">(</span><span class="variable">self</span><span class="punctuation">.</span><span class="variable">for_plot</span><span class="brackets">[</span><span class="string">'label'</span><span class="brackets">]</span><span class="punctuation">.</span><span class="variable">values</span><span class="paren">)</span>
        <span class="variable">texts</span> <span class="smooth_operator">=</span> <span class="variable">self</span><span class="punctuation">.</span><span class="variable">for_plot</span><span class="brackets">[</span><span class="string">'shap'</span><span class="brackets">]</span><span class="punctuation">.</span><span class="func_name">round</span><span class="paren">(</span><span class="number">2</span><span class="paren">)</span>

        <span class="variable">fig</span> <span class="smooth_operator">=</span> <span class="variable">go</span><span class="punctuation">.</span><span class="func_name">Figure</span><span class="paren">(</span><span class="variable">go</span><span class="punctuation">.</span><span class="func_name">Waterfall</span><span class="paren">(</span>
            <span class="variable">name</span> <span class="smooth_operator">=</span> <span class="string">"20"</span><span class="punctuation">,</span> <span class="variable">orientation</span> <span class="smooth_operator">=</span> <span class="string">"v"</span><span class="punctuation">,</span>
            <span class="variable">measure</span> <span class="smooth_operator">=</span> <span class="variable">ms</span><span class="punctuation">,</span>
            <span class="variable">x</span> <span class="smooth_operator">=</span> <span class="variable">xs</span><span class="punctuation">,</span>
            <span class="variable">textposition</span> <span class="smooth_operator">=</span> <span class="string">"outside"</span><span class="punctuation">,</span>
            <span class="variable">text</span> <span class="smooth_operator">=</span> <span class="variable">texts</span><span class="punctuation">,</span>
            <span class="variable">y</span> <span class="smooth_operator">=</span> <span class="variable">ys</span><span class="punctuation">,</span>
            <span class="variable">connector</span> <span class="smooth_operator">=</span> <span class="keys">{</span><span class="string">"line"</span><span class="punctuation">:</span><span class="keys">{</span><span class="string">"color"</span><span class="punctuation">:</span><span class="string">"rgb(63, 63, 63)"</span><span class="keys">}</span> <span class="keys">}</span><span class="punctuation">,</span>
           <span class="paren">)</span> <span class="paren">)</span>


        <span class="variable">layout</span> <span class="smooth_operator">=</span> <span class="variable">go</span><span class="punctuation">.</span><span class="func_name">Layout</span><span class="paren">(</span>
            <span class="variable">paper_bgcolor</span><span class="smooth_operator">=</span><span class="string">'rgba(0,0,0,0)'</span><span class="punctuation">,</span>
            <span class="variable">plot_bgcolor</span><span class="smooth_operator">=</span><span class="string">'rgba(0,0,0,0)'</span>
        <span class="paren">)</span>

        <span class="variable">fig</span><span class="punctuation">.</span><span class="func_name">update_layout</span><span class="paren">(</span>
            <span class="variable">template</span><span class="smooth_operator">=</span><span class="string">"plotly_white"</span><span class="punctuation">,</span>
            <span class="variable">title</span> <span class="smooth_operator">=</span><span class="string">"The prediction of this observation is "</span> <span class="punctuation">,</span>
            <span class="variable">margin</span><span class="smooth_operator">=</span><span class="func_name">dict</span><span class="paren">(</span><span class="variable">l</span><span class="smooth_operator">=</span><span class="number">120</span><span class="punctuation">,</span> <span class="variable">r</span><span class="smooth_operator">=</span><span class="number">120</span><span class="punctuation">,</span> <span class="variable">t</span><span class="smooth_operator">=</span><span class="number">60</span><span class="punctuation">,</span> <span class="variable">b</span><span class="smooth_operator">=</span><span class="number">60</span><span class="paren">)</span><span class="punctuation">,</span>
            <span class="variable">yaxis</span><span class="smooth_operator">=</span><span class="func_name">dict</span><span class="paren">(</span>
                <span class="variable">title_text</span><span class="smooth_operator">=</span><span class="string">"The predicted value"</span> 
            <span class="paren">)</span><span class="punctuation">,</span>
            <span class="variable">xaxis</span> <span class="smooth_operator">=</span><span class="func_name">dict</span><span class="paren">(</span>
                <span class="variable">tickangle</span> <span class="smooth_operator">=</span> <span class="smooth_operator">-</span><span class="number">90</span><span class="punctuation">,</span>
                <span class="variable">title_text</span> <span class="smooth_operator">=</span> <span class="string">"Variables"</span><span class="paren">)</span>
        <span class="paren">)</span>
        <span class="variable">fig</span><span class="punctuation">.</span><span class="func_name">write_html</span><span class="paren">(</span><span class="variable">self</span><span class="punctuation">.</span><span class="variable">path</span> <span class="smooth_operator">+</span> <span class="string">"/f.html"</span><span class="punctuation">,</span> <span class="variable">auto_open</span><span class="smooth_operator">=</span><span class="variable">True</span><span class="paren">)</span>    </pre>
</body>

</html>